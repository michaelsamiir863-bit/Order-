<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Cairo',sans-serif;
  background:#f4f6f9;
}
header{
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
  padding:20px;
  text-align:center;
}
.actions,.filters{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  margin:15px;
}
button{
  padding:10px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#2c5364;
  color:#fff;
}
.print{background:#00695c}
.container{padding:20px}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 6px 15px rgba(0,0,0,.08);
}
th,td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:center;
}
th{background:#f1f3f6}

tr.done{
  background:#e8f5e9;
}
.status-wait{color:#ff9800;font-weight:bold}
.status-done{color:#2e7d32;font-weight:bold}

.small{
  padding:6px 12px;
  font-size:13px;
  border-radius:6px;
}
.done-btn{background:#2e7d32}
.whats-btn{background:#25D366}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-content{
  background:#fff;
  padding:20px;
  border-radius:15px;
  width:90%;
  max-width:450px;
}
.modal input,.modal select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ccc;
}
</style>
</head>

<body>

<header>
<h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
<p>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ â€¢ Ø£Ø°ÙˆÙ† Ø§Ù„ÙØ±ÙˆØ¹</p>
</header>

<div class="actions">
<button onclick="openCustomer()">â• Ø·Ù„Ø¨ Ø¹Ù…ÙŠÙ„</button>
<button onclick="openBranch()">ğŸ“¦ Ø¥Ø°Ù† Ù…Ù† ÙØ±Ø¹</button>
<button class="print" onclick="printBranches()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø£Ø°ÙˆÙ† Ø§Ù„ÙØ±ÙˆØ¹</button>
</div>

<div class="filters">
<select id="fType">
  <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
  <option value="customer">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
  <option value="branch">Ø£Ø°ÙˆÙ† Ø§Ù„ÙØ±ÙˆØ¹</option>
</select>

<select id="fBranch">
  <option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
</select>

<select id="fStatus">
  <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
  <option value="waiting">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
  <option value="done">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</option>
</select>

<input type="date" id="fromDate">
<input type="date" id="toDate">

<button onclick="loadOrders()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
</div>

<div class="container">
<table>
<thead>
<tr>
<th>Ø§Ù„Ù†ÙˆØ¹</th>
<th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
<th>ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
<th>Ø§Ù„ÙØ±Ø¹ / Ø§Ù„Ø´Ø±ÙƒØ©</th>
<th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
</thead>
<tbody id="orders"></tbody>
</table>
</div>

<!-- Ø·Ù„Ø¨ Ø¹Ù…ÙŠÙ„ -->
<div class="modal" id="customerModal">
<div class="modal-content">
<h3>Ø·Ù„Ø¨ Ø¹Ù…ÙŠÙ„</h3>
<input id="c_item" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
<input id="c_qty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
<select id="c_type" onchange="toggleExternal()">
  <option value="branch">Ù…Ù† ÙØ±Ø¹</option>
  <option value="external">Ø·Ù„Ø¨ Ø®Ø§Ø±Ø¬ÙŠ</option>
</select>
<select id="c_branch"></select>
<input id="c_company" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© / Ø§Ù„Ù…Ø®Ø²Ù†" style="display:none">
<input id="c_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
<button onclick="saveCustomer()">Ø­ÙØ¸</button>
<button onclick="closeAll()">Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>

<!-- Ø¥Ø°Ù† ÙØ±Ø¹ -->
<div class="modal" id="branchModal">
<div class="modal-content">
<h3>Ø¥Ø°Ù† Ù…Ù† ÙØ±Ø¹</h3>
<input id="b_item" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
<input id="b_code" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
<input id="b_qty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
<select id="b_branch"></select>
<input id="b_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
<button onclick="saveBranch()">Ø­ÙØ¸</button>
<button onclick="closeAll()">Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>

<script>
/* Firebase Config */
const firebaseConfig = {
 apiKey: "AIzaSyAbC0MGRDan_3VeqO1B3n0aK-22p2cyAf4",
 authDomain: "tasks-e9f9d.firebaseapp.com",
 databaseURL: "https://tasks-e9f9d-default-rtdb.firebaseio.com",
 projectId: "tasks-e9f9d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ */
function loadBranches(){
 db.ref("branches").once("value",snap=>{
   const selects=[fBranch,c_branch,b_branch];
   selects.forEach(s=>s.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>');
   snap.forEach(b=>{
     selects.forEach(s=>{
       s.innerHTML+=`<option>${b.val().name}</option>`;
     });
   });
 });
}

/* ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° */
function openCustomer(){clearCustomer();customerModal.style.display="flex"}
function openBranch(){clearBranch();branchModal.style.display="flex"}
function closeAll(){document.querySelectorAll('.modal').forEach(m=>m.style.display="none")}

/* ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
function clearCustomer(){
 c_item.value=""; c_qty.value=""; c_company.value=""; c_notes.value="";
 c_type.value="branch"; toggleExternal();
}
function clearBranch(){
 b_item.value=""; b_code.value=""; b_qty.value=""; b_notes.value="";
}

/* Ø·Ù„Ø¨ Ø®Ø§Ø±Ø¬ÙŠ */
function toggleExternal(){
 const ext=c_type.value==="external";
 c_branch.style.display=ext?"none":"block";
 c_company.style.display=ext?"block":"none";
}

/* Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
function saveCustomer(){
 db.ref("orders/customer").push({
  item: c_item.value,
  qty: c_qty.value,
  branch: c_branch.value,
  company: c_company.value,
  notes: c_notes.value,
  time: Date.now(),
  status: "waiting"
 });
 closeAll(); loadOrders();
}

function saveBranch(){
 db.ref("orders/branch").push({
  item: b_item.value,
  code: b_code.value,
  qty: b_qty.value,
  branch: b_branch.value,
  notes: b_notes.value,
  time: Date.now(),
  status: "waiting"
 });
 closeAll(); loadOrders();
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
function loadOrders(){
 orders.innerHTML="";
 db.ref("orders").once("value",snap=>{
  snap.forEach(t=>{
   if(fType.value && fType.value!==t.key) return;
   t.forEach(o=>{
    const d=o.val();
    if(fBranch.value && d.branch!==fBranch.value) return;
    if(fStatus.value && d.status!==fStatus.value) return;

    const date=new Date(d.time).toLocaleString();

    orders.innerHTML+=`
    <tr class="${d.status==='done'?'done':''}">
      <td>${t.key==="branch"?"Ø¥Ø°Ù† ÙØ±Ø¹":"Ø·Ù„Ø¨ Ø¹Ù…ÙŠÙ„"}</td>
      <td>${d.item}</td>
      <td>${d.code||"-"}</td>
      <td>${d.qty}</td>
      <td>${d.branch||d.company||"-"}</td>
      <td>${d.notes||"-"}</td>
      <td>${date}</td>
      <td class="${d.status==='done'?'status-done':'status-wait'}">
        ${d.status==='done'?'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°':'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}
      </td>
      <td>
        ${d.status==='waiting'
          ? `<button class="small done-btn" onclick="setDone('${t.key}','${o.key}')">ØªÙ…</button>`
          : ''
        }
        ${t.key==="branch"
          ? `<br><button class="small whats-btn"
              onclick="reportWhatsApp('${d.branch}','${d.code}','${d.notes||""}')">
              ÙˆØ§ØªØ³Ø§Ø¨
            </button>`
          : ''
        }
      </td>
    </tr>`;
   });
  });
 });
}

/* ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© */
function setDone(type,id){
 db.ref(`orders/${type}/${id}/status`).set("done");
 loadOrders();
}

/* Ø¥Ø¨Ù„Ø§Øº ÙˆØ§ØªØ³Ø§Ø¨ */
function reportWhatsApp(branch,code,notes){
 let text=`Ù‡Ø¨Ø¹Øª Ø§Ø®Ø¯ ÙƒÙˆØ¯ ${code}\nÙ…Ù† ÙØ±Ø¹ ${branch}`;
 if(notes) text += `\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}`;
 const url="https://wa.me/?text="+encodeURIComponent(text);
 window.open(url,"_blank");
}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
function printBranches(){
 db.ref("orders/branch").once("value",snap=>{
  let rows="";
  snap.forEach(o=>{
   if(o.val().status!=="waiting") return;
   rows+=`
    <tr>
      <td>${o.val().branch}</td>
      <td>${o.val().code}</td>
      <td>${o.val().qty}</td>
    </tr>`;
  });

  const w=window.open("","","width=300");
  w.document.write(`
  <style>
    body{font-family:monospace;text-align:center}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:6px;text-align:center}
  </style>

  <h4>Ø¥Ø°Ù† Ø¥Ù„Ù‰ ÙØ±Ø¹ Ù†Ø¹Ù…Ø© Ø§Ù„Ù„Ù‡</h4>

  <table>
    <tr>
      <th>Ø§Ù„ÙØ±Ø¹</th>
      <th>Ø§Ù„ÙƒÙˆØ¯</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
    </tr>
    ${rows}
  </table>
  `);
  w.print();
 });
}

/* ØªØ´ØºÙŠÙ„ */
loadBranches();
loadOrders();
</script>

</body>
</html>


